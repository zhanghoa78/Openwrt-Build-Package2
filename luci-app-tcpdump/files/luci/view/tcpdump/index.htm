<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title><%:TCPDump%></title>
    <script type="text/javascript" src="<%=luci.cbi.script%>"></script>
    <script type="text/javascript" src="<%=luci.cbi.javascript%>"></script>
    <link rel="stylesheet" href="<%=luci.cbi.css%>">
</head>
<body>
    <h1><%:TCPDump%></h1>
    <div id="content"></div>
    <script type="text/javascript">
        'use strict';
        'require view';
        'require form';
        'require rpc';
        'require ui';
        'require network';

        // ✅ 最终正确版：
        // object 必须是 'luci.tcpdump' 才能匹配 controller/tcpdump.lua
        var callTcpdumpStart = rpc.declare({
            object: 'luci.tcpdump',
            method: 'start',
            params: ['interface', 'filter', 'filesize'],
            expect: { result: {} }
        });

        var callTcpdumpStop = rpc.declare({
            object: 'luci.tcpdump',
            method: 'stop',
            params: [],
            expect: { result: {} }
        });

        var callTcpdumpStatus = rpc.declare({
            object: 'luci.tcpdump',
            method: 'status',
            params: [],
            expect: { result: {} }
        });

        // 主视图
        return view.extend({
            title: _('TCPDump'),
            
            render: function(data) {
                var m, s, o;

                m = new form.Form('tcpdump', _('TCPDump Capture'),
                    _('这是一个简单的 tcpdump 前端。抓包文件将保存在 /tmp/tcpdump.pcap。' +
                      '你需要使用 SCP 或 WinSCP 手动下载它。'));

                s = m.section(form.Section, 'settings', 'tcpdump');
                s.anonymous = true;

                o = s.option(form.Value, 'interface', _('Interface'),
                    _('选择要抓包的网络接口。'));
                o.value('br-lan', 'LAN (br-lan)');
                o.value('eth0', 'WAN (eth0)'); 
                o.placeholder = 'br-lan'; 
                o.load = function(section_id) {
                    return network.getDevices().then(function(devices) {
                        devices.forEach(function(dev) {
                            o.value(dev.getName(), dev.getName());
                        });
                    });
                };

                o = s.option(form.Value, 'filter', _('Filter'),
                    _('BPF 过滤器 (例如: "port 80" 或 "host 192.168.1.100")'));
                o.placeholder = 'port 67 or port 68 or port 80';

                o = s.option(form.Value, 'filesize', _('Size Limit (MB)'),
                    _('当文件达到此大小（单位MB）时自动停止抓包。留空则无限制。'));
                o.datatype = 'uinteger';
                o.placeholder = '10';

                s = m.section(form.Section, 'control', 'tcpdump');
                s.anonymous = true;

                o = s.option(form.DummyValue, 'status', _('Status'));
                o.raw = true;
                o.value = '...';
                o.id = 'tcpdump-status';

                o = s.option(form.Button, '_control', _('Control'));
                o.inputtitle = _('Start Capture');
                o.inputstyle = 'apply';
                o.id = 'btn-start';
                o.onclick = function() {
                    var map = this.map;
                    var iface = map.data.interface || 'br-lan';
                    var filter = map.data.filter || '';
                    var filesize = map.data.filesize || null; 
                    
                    return callTcpdumpStart(iface, filter, filesize).then(function(result) {
                        if (result.error) {
                            ui.addNotification(null, E('p', _('Error: ') + result.error));
                        } else {
                            ui.addNotification(null, E('p', _('Capture started.')));
                        }
                        view.self.updateStatus();
                    });
                };

                o = s.option(form.Button, '_stop');
                o.inputtitle = _('Stop Capture');
                o.inputstyle = 'reset';
                o.id = 'btn-stop';
                o.onclick = function() {
                    return callTcpdumpStop().then(function(result) {
                        ui.addNotification(null, E('p', _('Capture stopped and files cleaned.')));
                        view.self.updateStatus();
                    });
                };

                return m.render();
            },

            load: function() {
                L.Poll.add(this.updateStatus.bind(this), 3);
                return this.updateStatus();
            },

            updateStatus: function() {
                var statusEl = document.getElementById('tcpdump-status');
                
                return callTcpdumpStatus().then(function(result) {
                    var startBtn = document.getElementById('btn-start');
                    var stopBtn = document.getElementById('btn-stop');

                    if (result.running) {
                        statusEl.innerHTML = '<span style="color:green; font-weight:bold;">' + 
                            _('RUNNING (PID: %h)').format(result.pid) + '</span>';
                        if (startBtn) startBtn.disabled = true;
                        if (stopBtn) stopBtn.disabled = false;
                    } else {
                        statusEl.innerHTML = '<span style="color:red; font-weight:bold;">' + 
                            _('STOPPED') + '</span>';
                        if (startBtn) startBtn.disabled = false;
                        if (stopBtn) stopBtn.disabled = true;
                    }
                });
            }
        });
    </script>
</body>
</html>
