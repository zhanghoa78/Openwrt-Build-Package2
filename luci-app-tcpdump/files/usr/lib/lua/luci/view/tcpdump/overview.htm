<%+header%>

<style>
.switch { position: relative; display: inline-block; width: 50px; height: 24px; vertical-align: middle; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; }
input:checked + .slider { background-color: #5cb85c; }
input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
input:checked + .slider:before { transform: translateX(26px); }
.slider.round { border-radius: 24px; }
.slider.round:before { border-radius: 50%; }
</style>

<div class="cbi-map">
	<h2 name="content"><%:TCPDump 数据包捕获%></h2>
	<div class="cbi-map-descr">
		<%:简单的 tcpdump 数据包捕获网页界面。%><br>
		<%:捕获文件保存在 /tmp/tcpdump.pcap。%>
	</div>

	<fieldset class="cbi-section">
		<legend><%:捕获设置%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络接口%></label>
			<div class="cbi-value-field">
				<select id="interface" class="cbi-input-select">
					<option value=""><%:正在加载接口...%></option>
				</select>
				<button id="btn-refresh" class="cbi-button cbi-button-neutral" onclick="refreshInterfaces()" style="margin-left: 10px;">
					<%:刷新%>
				</button>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络数据过滤器%></label>
			<div class="cbi-value-field">
				<input type="text" id="filter" class="cbi-input-text" 
					   placeholder="输入 BPF 过滤器，例如: port 80 or port 443" />
				
                <!-- 修改后的快速选择按钮 -->
				<div style="margin-top: 10px;">
					<span style="margin-right: 5px;"><%:快速选择服务:%></span>
					<button class="cbi-button cbi-button-sm" onclick="setFilter('port 80 or port 443')"><%:网页%></button>
					<button class="cbi-button cbi-button-sm" onclick="setFilter('port 67 or port 68')"><%:DHCP%></button>
					<button class="cbi-button cbi-button-sm" onclick="setFilter('port 53')"><%:DNS%></button>
					<button class="cbi-button cbi-button-sm" onclick="setFilter('port 22')"><%:SSH%></button>
				</div>
				
				<div class="cbi-value-description">
					<%:使用 BPF 语法。留空捕获所有流量。%>
				</div>
			</div>
		</div>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:文件大小限制 (MB)%></label>
			<div class="cbi-value-field">
				<input type="number" id="filesize" class="cbi-input-text" placeholder="10" min="1" max="100" style="max-width: 100px;" />
				<div class="cbi-value-description">
					<%:达到文件大小限制时，tcpdump 将自动停止。1-100MB。%>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:包数量限制%></label>
			<div class="cbi-value-field">
				<input type="number" id="count" class="cbi-input-text" placeholder="1000" min="1" max="100000" style="max-width: 100px;" />
				<div class="cbi-value-description">
					<%:捕获指定数量的包后自动停止，留空表示无限制。%>
				</div>
			</div>
		</div>
	</fieldset>

    <fieldset class="cbi-section" id="advanced-settings" style="display: none;">
        <legend><%:高级功能%></legend>
        <div class="cbi-value">
            <label class="cbi-value-title" for="broute-toggle"><%:捕获二层桥接流量%></label>
            <div class="cbi-value-field">
                <label class="switch">
                    <input type="checkbox" id="broute-toggle" onchange="toggleBridgeTap()">
                    <span class="slider round"></span>
                </label>
                <span id="broute-status" style="margin-left: 10px; vertical-align: middle;"></span>
                <div class="cbi-value-description">
                    <%:开启此项可捕获同一网桥下（如 br-lan）各端口之间的通信流量。%>
                    <br>
                    <strong style="color: #d9534f;"><%:警告：%></strong>
                    <%:此功能会增加 CPU 负载，仅在需要时开启，抓包结束后务必关闭。%>
                </div>
            </div>
        </div>
    </fieldset>

	<fieldset class="cbi-section">
		<legend><%:状态与控制%></legend>
		<div class="cbi-value">
			<label class="cbi-value-title"><%:当前状态%></label>
			<div class="cbi-value-field">
				<span id="status-text"><%:未运行%></span>
				<span style="margin-left: 20px;"><%:文件大小: %></span><span id="file-size">0 KB</span>
			</div>
		</div>
		<div class="cbi-value">
			<div class="cbi-value-field">
				<button id="btn-start" class="cbi-button cbi-button-apply" onclick="startCapture()">
					<%:开始捕获%>
				</button>
				<button id="btn-stop" class="cbi-button cbi-button-remove" onclick="stopCapture()" disabled>
					<%:停止捕获%>
				</button>
				<button id="btn-download" class="cbi-button cbi-button-neutral" onclick="downloadCapture()" disabled>
					<%:下载文件%>
				</button>
				<button id="btn-delete" class="cbi-button cbi-button-remove" onclick="deleteCapture()" disabled>
					<%:删除文件%>
				</button>
			</div>
		</div>
	</fieldset>
</div>

<script type="text/javascript">
//<![CDATA[
var tcpdumpState = {
    isUpdating: false,
    updateInterval: 2000
};

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `cbi-tooltip cbi-tooltip-${type === 'success' ? 'success' : 'error'}`;
    notification.textContent = message;
    Object.assign(notification.style, {
        position: 'fixed',
        top: '10px',
        right: '10px',
        display: 'block',
        zIndex: 1000
    });
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.display = 'none';
        document.body.removeChild(notification);
    }, 3000);
}

async function apiCall(url, options = {}) {
    try {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }
        };
        const finalOptions = Object.assign(defaultOptions, options);
        const response = await fetch(url, finalOptions);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error('API call failed:', error);
        showNotification(`请求失败: ${error.message}`, 'error');
        return null;
    }
}

async function loadInterfaces() {
    const select = document.getElementById('interface');
    select.innerHTML = '<option value=""><%:正在加载接口...%></option>';
    const data = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "interfaces")%>');
    if (data && Array.isArray(data)) {
        select.innerHTML = '';
        data.forEach(iface => {
            const option = document.createElement('option');
            option.value = iface;
            option.textContent = iface;
            select.appendChild(option);
        });
    } else {
        select.innerHTML = '<option value=""><%:加载接口失败%></option>';
    }
}

function refreshInterfaces() { loadInterfaces(); }

async function updateStatus() {
    if (tcpdumpState.isUpdating) return;
    tcpdumpState.isUpdating = true;
    const data = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "status")%>');
    if (data) {
        updateUI(data);
    }
    tcpdumpState.isUpdating = false;
}

function updateUI(data) {
    const statusText = document.getElementById('status-text');
    const fileSizeDisplay = document.getElementById('file-size');

    if (data.running) {
        statusText.textContent = '<%:正在捕获...%>';
        statusText.style.color = '#39b54a';
    } else {
        statusText.textContent = '<%:未运行%>';
        statusText.style.color = '#d9534f';
    }
    fileSizeDisplay.textContent = formatFileSize(data.file_size);

    var advancedSettings = document.getElementById('advanced-settings');
    var brouteToggle = document.getElementById('broute-toggle');
    var brouteStatus = document.getElementById('broute-status');

    if (data.ebtables_installed) {
        advancedSettings.style.display = '';
        brouteToggle.checked = data.broute_enabled;
        brouteToggle.disabled = data.running;
        brouteStatus.textContent = data.broute_enabled ? '<%:已开启%>' : '<%:已关闭%>';
        brouteStatus.style.color = data.broute_enabled ? '#39b54a' : '#d9534f';
    } else {
        advancedSettings.style.display = 'none';
    }

    document.getElementById('btn-start').disabled = data.running;
    document.getElementById('btn-stop').disabled = !data.running;
    document.getElementById('btn-download').disabled = !data.file_exists || data.running;
    document.getElementById('btn-delete').disabled = !data.file_exists || data.running;
}

// 新增的辅助函数，用于直接设置过滤器内容
function setFilter(filterText) {
    document.getElementById('filter').value = filterText;
}

function addPortFilter(port) {
    const filterInput = document.getElementById('filter');
    let currentFilter = filterInput.value.trim();
    if (currentFilter === '') {
        filterInput.value = `port ${port}`;
    } else {
        if (currentFilter.includes('port')) {
            filterInput.value = `${currentFilter} or port ${port}`;
        } else {
            filterInput.value = `${currentFilter} and port ${port}`;
        }
    }
}

async function validateInputs() {
    const iface = document.getElementById('interface').value;
    if (!iface) {
        showNotification('<%:请选择网络接口%>', 'error');
        return false;
    }
    const filter = document.getElementById('filter').value;
    if (/[;&|`$()<>\\]/.test(filter)) {
        showNotification('<%:过滤器包含无效或危险字符%>', 'error');
        return false;
    }
    return true;
}

async function startCapture() {
    if (!await validateInputs()) return;
    var btn = document.getElementById('btn-start');
    btn.disabled = true;
    btn.textContent = '<%:启动中...%>';

    const formData = new FormData();
    formData.append('interface', document.getElementById('interface').value);
    formData.append('filter', document.getElementById('filter').value);
    formData.append('filesize', document.getElementById('filesize').value || '');
    formData.append('count', document.getElementById('count').value || '');

    const result = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "start")%>', {
        method: 'POST',
        body: new URLSearchParams(formData)
    });

    if (result) showNotification(result.message, result.success ? 'success' : 'error');
    btn.textContent = '<%:开始捕获%>';
    setTimeout(updateStatus, 500);
}

async function stopCapture() {
    var btn = document.getElementById('btn-stop');
    btn.disabled = true;
    btn.textContent = '<%:停止中...%>';
    
    const result = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "stop")%>', { method: 'POST' });
    
    if (result) showNotification(result.message, result.success ? 'success' : 'error');
    btn.textContent = '<%:停止捕获%>';
    setTimeout(updateStatus, 500);
}

function downloadCapture() {
    window.location.href = '<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "download")%>';
}

async function deleteCapture() {
    if (!confirm('<%:确定要删除捕获文件吗？此操作不可撤销。%>')) return;
    const result = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "delete")%>', { method: 'POST' });
    if (result) showNotification(result.message, result.success ? 'success' : 'error');
    updateStatus();
}

async function toggleBridgeTap() {
    var toggle = document.getElementById('broute-toggle');
    var enable = toggle.checked;
    toggle.disabled = true;
    const result = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "broute")%>?enable=' + enable);
    if (result) showNotification(result.message, result.success ? 'success' : 'error');
    updateStatus();
}

document.addEventListener('DOMContentLoaded', function() {
    loadInterfaces();
    updateStatus();
    setInterval(updateStatus, tcpdumpState.updateInterval);
});
//]]>
</script>

<%+footer%>
