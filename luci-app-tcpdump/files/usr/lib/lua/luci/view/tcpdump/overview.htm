<%+header%>

<link rel="stylesheet" href="<%=resource%>/view/tcpdump/assets/tcpdump.css" />

<div class="cbi-map">
	<h2 name="content"><%:TCPDump 数据包捕获%></h2>
	<div class="cbi-map-descr">
		<%:简单的 tcpdump 数据包捕获网页界面。%><br>
		<%:捕获文件保存在 /tmp/tcpdump.pcap。%>
	</div>

	<fieldset class="cbi-section">
		<legend><%:捕获设置%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络接口%></label>
			<div class="cbi-value-field">
				<div class="interface-row">
					<select id="interface" class="cbi-input-select interface-select">
						<option value=""><%:正在加载接口...%></option>
					</select>
					<button id="btn-refresh" class="tcpdump-btn tcpdump-btn-reload" onclick="refreshInterfaces()">
						<%:刷新接口%>
					</button>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络数据过滤器%></label>
			<div class="cbi-value-field">
				<div class="filter-input-row">
					<input type="text" id="filter" class="cbi-input-text filter-input" 
						   placeholder="输入 BPF 过滤器，例如: port 80 or port 443" />
					<button type="button" class="tcpdump-btn tcpdump-btn-preset advanced-filter-btn" onclick="showAdvancedFilterDialog()">
						<%:高级过滤器%>
					</button>
				</div>
				
				<div class="port-preset-row">
					<span class="preset-label"><%:快速选择端口:%></span>
					<div class="port-preset-container">
						<button class="port-btn" onclick="addPortFilter('80')">HTTP (80)</button>
						<button class="port-btn" onclick="addPortFilter('443')">HTTPS (443)</button>
						<button class="port-btn" onclick="addPortFilter('22')">SSH (22)</button>
						<button class="port-btn" onclick="addPortFilter('53')">DNS (53)</button>
						<button class="port-btn" onclick="addPortFilter('21')">FTP (21)</button>
						<button class="port-btn" onclick="addPortFilter('25')">SMTP (25)</button>
					</div>
				</div>
				
				<div class="cbi-value-description">
					<%:使用 BPF 语法，支持多个端口: port 80 or port 443。%><br>
					<%:留空捕获所有流量。%>
				</div>
			</div>
		</div>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:文件大小限制 (MB)%></label>
			<div class="cbi-value-field">
				<div class="file-size-row">
					<div class="file-size-container">
						<input type="number" id="filesize" class="cbi-input-text file-size-input" placeholder="10" min="1" max="100" />
						<span>MB</span>
					</div>
				</div>
				<div class="cbi-value-description">
					<%:达到文件大小限制时，tcpdump 将自动停止。1-100MB。%>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:包数量限制%></label>
			<div class="cbi-value-field">
				<input type="number" id="count" class="cbi-input-text" placeholder="1000" min="1" max="100000" />
				<div class="cbi-value-description">
					<%:捕获指定数量的包后自动停止，留空表示无限制。%>
				</div>
			</div>
		</div>
	</fieldset>

    <fieldset class="cbi-section" id="advanced-settings" style="display: none;">
        <legend><%:高级功能%></legend>
        <div class="cbi-value">
            <label class="cbi-value-title" for="broute-toggle"><%:捕获二层桥接流量%></label>
            <div class="cbi-value-field">
                <label class="switch">
                    <input type="checkbox" id="broute-toggle" onchange="toggleBridgeTap()">
                    <span class="slider round"></span>
                </label>
                <span id="broute-status" style="margin-left: 10px; vertical-align: middle;"></span>
                <div class="cbi-value-description">
                    <%:开启此项可捕获同一网桥下（如 br-lan）各端口之间的通信流量（例如光猫和机顶盒）。%>
                    <br>
                    <strong style="color: #d9534f;"><%:警告：%></strong>
                    <%:此功能会增加 CPU 负载，仅在需要时开启，抓包结束后务必关闭。%>
                </div>
            </div>
        </div>
    </fieldset>

	<fieldset class="cbi-section">
		<legend><%:状态与控制%></legend>
		<div class="cbi-value">
			<label class="cbi-value-title"><%:当前状态%></label>
			<div class="cbi-value-field">
				<div class="status-container">
					<span class="status-indicator status-stopped" id="status-light"></span>
					<span id="status-text"><%:未运行%></span>
					<div class="file-size-display">
						<span><%:文件大小: %></span><span id="file-size">0 KB</span>
					</div>
				</div>
			</div>
		</div>
		<div class="cbi-value">
			<div class="cbi-value-field">
				<div class="control-buttons">
					<button id="btn-start" class="tcpdump-btn tcpdump-btn-start" onclick="startCapture()">
						<%:开始捕获%>
					</button>
					<button id="btn-stop" class="tcpdump-btn tcpdump-btn-stop" onclick="stopCapture()" disabled>
						<%:停止捕获%>
					</button>
					<button id="btn-download" class="tcpdump-btn tcpdump-btn-download" onclick="downloadCapture()" disabled>
						<%:下载文件%>
					</button>
					<button id="btn-delete" class="tcpdump-btn tcpdump-btn-delete" onclick="deleteCapture()" disabled>
						<%:删除文件%>
					</button>
				</div>
			</div>
		</div>
	</fieldset>

	<div class="dialog-overlay" id="dialog-overlay" onclick="closeAdvancedFilterDialog()"></div>
	<div class="advanced-filter-dialog" id="advanced-filter-dialog">
		<span class="close-dialog" onclick="closeAdvancedFilterDialog()">&times;</span>
		<h3><%:高级过滤器%></h3>
		<p><%:常用过滤器示例:%></p>
		<ul>
			<li>host 192.168.1.1 - <%:捕获特定主机的流量%></li>
			<li>net 192.168.1.0/24 - <%:捕获特定网络的流量%></li>
			<li>portrange 80-100 - <%:捕获端口范围的流量%></li>
			<li>tcp or udp - <%:捕获TCP或UDP流量%></li>
			<li>src host 192.168.1.1 - <%:源地址过滤%></li>
			<li>dst host 192.168.1.1 - <%:目标地址过滤%></li>
		</ul>
		<p><%:在上方输入框中输入BPF过滤器表达式%></p>
	</div>
</div>

<script type="text/javascript">
//<![CDATA[
var tcpdumpState = {
    isUpdating: false,
    updateInterval: 2000
};

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    Object.assign(notification.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        padding: '10px 20px',
        borderRadius: '4px',
        color: 'white',
        zIndex: '10000',
        boxShadow: '0 2px 10px rgba(0,0,0,0.2)',
        animation: 'slideIn 0.3s ease-out'
    });
    if (type === 'success') notification.style.backgroundColor = '#28a745';
    else if (type === 'error') notification.style.backgroundColor = '#dc3545';
    else notification.style.backgroundColor = '#17a2b8';
    document.body.appendChild(notification);
    setTimeout(() => document.body.removeChild(notification), 3000);
}

async function apiCall(url, options = {}) {
    try {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            }
        };
        const finalOptions = Object.assign(defaultOptions, options);
        const response = await fetch(url, finalOptions);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error('API call failed:', error);
        showNotification(`请求失败: ${error.message}`, 'error');
        return null;
    }
}

async function loadInterfaces() {
    const select = document.getElementById('interface');
    select.innerHTML = '<option value=""><%:正在加载接口...%></option>';
    const data = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "interfaces")%>');
    if (data && Array.isArray(data)) {
        select.innerHTML = '';
        data.forEach(iface => {
            const option = document.createElement('option');
            option.value = iface;
            option.textContent = iface;
            select.appendChild(option);
        });
    } else {
        select.innerHTML = '<option value=""><%:加载接口失败%></option>';
    }
}

function refreshInterfaces() { loadInterfaces(); }

async function updateStatus() {
    if (tcpdumpState.isUpdating) return;
    tcpdumpState.isUpdating = true;
    const data = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "status")%>');
    if (data) {
        updateUI(data);
    }
    tcpdumpState.isUpdating = false;
}

function updateUI(data) {
    const statusLight = document.getElementById('status-light');
    const statusText = document.getElementById('status-text');
    const fileSizeDisplay = document.getElementById('file-size');

    if (data.running) {
        statusLight.className = 'status-indicator status-running';
        statusText.textContent = '<%:正在捕获...%>';
    } else {
        statusLight.className = 'status-indicator status-stopped';
        statusText.textContent = '<%:未运行%>';
    }
    fileSizeDisplay.textContent = formatFileSize(data.file_size);

    var advancedSettings = document.getElementById('advanced-settings');
    var brouteToggle = document.getElementById('broute-toggle');
    var brouteStatus = document.getElementById('broute-status');

    if (data.ebtables_installed) {
        advancedSettings.style.display = 'block';
        brouteToggle.checked = data.broute_enabled;
        brouteToggle.disabled = data.running;
        brouteStatus.textContent = data.broute_enabled ? '<%:已开启%>' : '<%:已关闭%>';
        brouteStatus.className = data.broute_enabled ? 'status-running' : 'status-stopped';
    } else {
        advancedSettings.style.display = 'none';
    }

    document.getElementById('btn-start').disabled = data.running;
    document.getElementById('btn-stop').disabled = !data.running;
    document.getElementById('btn-download').disabled = !data.file_exists || data.running;
    document.getElementById('btn-delete').disabled = !data.file_exists || data.running;
}

function addPortFilter(port) {
    const filterInput = document.getElementById('filter');
    let currentFilter = filterInput.value.trim();
    if (currentFilter === '') {
        filterInput.value = `port ${port}`;
    } else {
        if (currentFilter.includes('port')) {
            filterInput.value = `${currentFilter} or port ${port}`;
        } else {
            filterInput.value = `${currentFilter} and port ${port}`;
        }
    }
}

function showAdvancedFilterDialog() {
    document.getElementById('advanced-filter-dialog').style.display = 'block';
    document.getElementById('dialog-overlay').style.display = 'block';
}

function closeAdvancedFilterDialog() {
    document.getElementById('advanced-filter-dialog').style.display = 'none';
    document.getElementById('dialog-overlay').style.display = 'none';
}

async function validateInputs() {
    const iface = document.getElementById('interface').value;
    if (!iface) {
        showNotification('<%:请选择网络接口%>', 'error');
        return false;
    }
    const filter = document.getElementById('filter').value;
    // Simple client-side check, robust check is on the backend
    if (filter.match(/[;&|`$()]/)) {
        showNotification('<%:过滤器包含无效字符%>', 'error');
        return false;
    }
    return true;
}

async function startCapture() {
    if (!await validateInputs()) return;
    var btn = document.getElementById('btn-start');
    btn.disabled = true;
    btn.textContent = '<%:启动中...%>';

    const formData = new FormData();
    formData.append('interface', document.getElementById('interface').value);
    formData.append('filter', document.getElementById('filter').value);
    formData.append('filesize', document.getElementById('filesize').value || '');
    formData.append('count', document.getElementById('count').value || '');

    const result = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "start")%>', {
        method: 'POST',
        body: new URLSearchParams(formData)
    });

    if (result) showNotification(result.message, result.success ? 'success' : 'error');
    btn.textContent = '<%:开始捕获%>';
    setTimeout(updateStatus, 500);
}

async function stopCapture() {
    var btn = document.getElementById('btn-stop');
    btn.disabled = true;
    btn.textContent = '<%:停止中...%>';
    
    // The backend's stop action will handle broute cleanup reliably.
    const result = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "stop")%>', { method: 'POST' });
    
    if (result) showNotification(result.message, result.success ? 'success' : 'error');
    btn.textContent = '<%:停止捕获%>';
    setTimeout(updateStatus, 500);
}

async function downloadCapture() {
    // This method is robust for triggering downloads.
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = '<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "download")%>';
    document.body.appendChild(iframe);
    setTimeout(() => document.body.removeChild(iframe), 1000);
}

async function deleteCapture() {
    if (!confirm('<%:确定要删除捕获文件吗？此操作不可撤销。%>')) return;
    const result = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "delete")%>', { method: 'POST' });
    if (result) showNotification(result.message, result.success ? 'success' : 'error');
    // After deletion, immediately update status to reflect file non-existence
    updateStatus();
}

async function toggleBridgeTap() {
    var toggle = document.getElementById('broute-toggle');
    var enable = toggle.checked;
    toggle.disabled = true;
    const result = await apiCall('<%=luci.dispatcher.build_url("admin", "services", "tcpdump", "broute")%>?enable=' + enable);
    if (result) showNotification(result.message, result.success ? 'success' : 'error');
    // Always call updateStatus to get the authoritative state from backend
    updateStatus();
}

document.addEventListener('DOMContentLoaded', function() {
    loadInterfaces();
    updateStatus(); // Initial status check
    setInterval(updateStatus, tcpdumpState.updateInterval);
});
//]]>
</script>

<%+footer%>
