<%+header%>

<div class="cbi-map">
	<h2 name="content"><%:TCPDump 数据包捕获%></h2>
	<div class="cbi-map-descr">
		<%:简单的 tcpdump 数据包捕获网页界面。捕获文件保存在 /tmp/tcpdump.pcap。%>
	</div>

	<fieldset class="cbi-section">
		<legend><%:捕获设置%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络接口%></label>
			<div class="cbi-value-field">
				<select id="interface" class="cbi-input-select">
					<option value=""><%:正在加载接口...%></option>
				</select>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:BPF 过滤器%></label>
			<div class="cbi-value-field">
				<input type="text" id="filter" class="cbi-input-text" placeholder="port 80" style="width: 300px;" />
				<div class="cbi-value-description">
					<%:示例: "port 80", "host 192.168.1.100", "tcp and port 443"，留空捕获所有流量%>
				</div>
			</div>
		</div>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:文件大小限制 (MB)%></label>
			<div class="cbi-value-field">
				<input type="number" id="filesize" class="cbi-input-text" placeholder="10" min="1" max="1000" style="width: 80px;" />
				<div class="cbi-value-description">
					<%:最大文件大小 (1-1000MB)，留空表示无限制%>
				</div>
			</div>
		</div>
	</fieldset>

	<fieldset class="cbi-section">
		<legend><%:状态与控制%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:状态%></label>
			<div class="cbi-value-field">
				<span id="status-text" style="font-weight: bold; padding: 6px 12px; border-radius: 4px; font-size: 14px; background: #f0f0f0;">
					<%:加载中...%>
				</span>
			</div>
		</div>

		<div class="cbi-value cbi-value-last">
			<label class="cbi-value-title"><%:操作%></label>
			<div class="cbi-value-field">
				<button id="btn-start" class="cbi-button cbi-button-apply" onclick="startCapture()">
					<%:开始捕获%>
				</button>
				<button id="btn-stop" class="cbi-button cbi-button-reset" onclick="stopCapture()" disabled>
					<%:停止捕获%>
				</button>
				<button id="btn-download" class="cbi-button cbi-button-download" onclick="downloadCapture()">
					<%:下载文件%>
				</button>
				<button id="btn-refresh" class="cbi-button cbi-button-reload" onclick="refreshInterfaces()">
					<%:刷新接口%>
				</button>
			</div>
		</div>
	</fieldset>
</div>

<script type="text/javascript">
//<![CDATA[

// 加载网络接口列表
function loadInterfaces() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/interfaces")%>', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                var interfaces = JSON.parse(xhr.responseText);
                var select = document.getElementById('interface');
                select.innerHTML = '';
                
                if (interfaces.length === 0) {
                    var option = document.createElement('option');
                    option.value = '';
                    option.textContent = '未找到网络接口';
                    select.appendChild(option);
                } else {
                    // 添加默认选项
                    var defaultOption = document.createElement('option');
                    defaultOption.value = 'br-lan';
                    defaultOption.textContent = 'br-lan (默认)';
                    select.appendChild(defaultOption);
                    
                    // 添加其他接口
                    interfaces.forEach(function(iface) {
                        if (iface !== 'br-lan') {
                            var option = document.createElement('option');
                            option.value = iface;
                            option.textContent = iface;
                            select.appendChild(option);
                        }
                    });
                }
            } catch(e) {
                console.error('加载接口时出错:', e);
                var select = document.getElementById('interface');
                select.innerHTML = '<option value="">加载接口失败</option>';
            }
        }
    };
    xhr.send();
}

// 更新状态显示
function updateStatus() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/ajax_status")%>', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);
                updateUI(data);
            } catch(e) {
                console.error('更新状态时出错:', e);
            }
        }
    };
    xhr.send();
}

function updateUI(data) {
    var statusEl = document.getElementById('status-text');
    var startBtn = document.getElementById('btn-start');
    var stopBtn = document.getElementById('btn-stop');
    
    if (!statusEl) return;
    
    if (data.running) {
        statusEl.innerHTML = '<span style="color: green; background: #e8f5e8; padding: 6px 12px; border-radius: 4px; font-size: 14px;">' + 
            '运行中' + (data.pid ? ' (PID: ' + data.pid + ')' : '') + '</span>';
        if (startBtn) startBtn.disabled = true;
        if (stopBtn) stopBtn.disabled = false;
    } else {
        statusEl.innerHTML = '<span style="color: red; background: #fde8e8; padding: 6px 12px; border-radius: 4px; font-size: 14px;">已停止</span>';
        if (startBtn) startBtn.disabled = false;
        if (stopBtn) stopBtn.disabled = true;
    }
}

function startCapture() {
    var interface = document.getElementById('interface').value || 'br-lan';
    var filter = document.getElementById('filter').value || '';
    var filesize = document.getElementById('filesize').value || '';
    
    var startBtn = document.getElementById('btn-start');
    if (startBtn) {
        startBtn.disabled = true;
        startBtn.textContent = '启动中...';
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/start")%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (startBtn) {
                startBtn.textContent = '开始捕获';
            }
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (!result.success) {
                        alert('启动失败: ' + result.message);
                    } else {
                        // 成功启动，更新状态
                        setTimeout(updateStatus, 2000);
                    }
                } catch(e) {
                    console.error('解析响应时出错:', e);
                }
            }
        }
    };
    
    var params = 'interface=' + encodeURIComponent(interface) + 
                 '&filter=' + encodeURIComponent(filter) + 
                 '&filesize=' + encodeURIComponent(filesize);
    xhr.send(params);
}

function stopCapture() {
    var stopBtn = document.getElementById('btn-stop');
    if (stopBtn) {
        stopBtn.disabled = true;
        stopBtn.textContent = '停止中...';
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/stop")%>', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            if (stopBtn) {
                stopBtn.textContent = '停止捕获';
            }
            setTimeout(updateStatus, 1000);
        }
    };
    xhr.send();
}

function downloadCapture() {
    window.open('<%=url("admin/services/tcpdump/download")%>', '_blank');
}

function refreshInterfaces() {
    var refreshBtn = document.getElementById('btn-refresh');
    if (refreshBtn) {
        refreshBtn.textContent = '刷新中...';
    }
    loadInterfaces();
    setTimeout(function() {
        if (refreshBtn) {
            refreshBtn.textContent = '刷新接口';
        }
    }, 1000);
}

// 初始化页面
document.addEventListener('DOMContentLoaded', function() {
    loadInterfaces();
    updateStatus();
    // 每3秒更新一次状态
    setInterval(updateStatus, 3000);
});

//]]>
</script>

<%+footer%>
