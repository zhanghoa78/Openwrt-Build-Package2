<%+header%>

<!-- 引入外部 CSS -->
<link rel="stylesheet" href="<%=resource%>/view/tcpdump/assets/tcpdump.css" />

<div class="cbi-map">
	<h2 name="content"><%:TCPDump 数据包捕获%></h2>
	<div class="cbi-map-descr">
		<%:简单的 tcpdump 数据包捕获网页界面。%><br>
		<%:捕获文件保存在 /tmp/tcpdump.pcap。%>
	</div>

	<fieldset class="cbi-section">
		<legend><%:捕获设置%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络接口%></label>
			<div class="cbi-value-field">
				<div class="interface-row">
					<select id="interface" class="cbi-input-select interface-select">
						<option value=""><%:正在加载接口...%></option>
					</select>
					<button id="btn-refresh" class="tcpdump-btn tcpdump-btn-reload" onclick="refreshInterfaces()">
						<%:刷新接口%>
					</button>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:网络数据过滤器%></label>
			<div class="cbi-value-field">
				<div class="filter-input-row">
					<input type="text" id="filter" class="cbi-input-text filter-input" 
						   placeholder="输入 BPF 过滤器，例如: port 80 or port 443" />
					<button type="button" class="tcpdump-btn tcpdump-btn-preset advanced-filter-btn" onclick="showAdvancedFilterDialog()">
						<%:高级过滤器%>
					</button>
				</div>
				
				<div class="port-preset-row">
					<span class="preset-label"><%:快速选择端口:%></span>
					<div class="port-preset-container">
						<div class="port-preset-line">
							<button type="button" class="tcpdump-btn tcpdump-btn-preset" data-port="80">80 (HTTP)</button>
							<button type="button" class="tcpdump-btn tcpdump-btn-preset" data-port="443">443 (HTTPS)</button>
							<button type="button" class="tcpdump-btn tcpdump-btn-preset" data-port="53">53 (DNS)</button>
							<button type="button" class="tcpdump-btn tcpdump-btn-preset" data-port="22">22 (SSH)</button>
						</div>
						<div class="port-preset-line">
							<button type="button" class="tcpdump-btn tcpdump-btn-preset" data-port="67">67 (DHCP)</button>
							<button type="button" class="tcpdump-btn tcpdump-btn-preset" data-port="68">68 (DHCP)</button>
							<button type="button" class="tcpdump-btn tcpdump-btn-preset" data-port="123">123 (NTP)</button>
							<button type="button" class="tcpdump-btn tcpdump-btn-preset" data-port="993">993 (IMAPS)</button>
						</div>
					</div>
				</div>
				
				<div class="cbi-value-description">
					<%:使用 BPF 语法，支持多个端口: port 80 or port 443。%><br>
					<%:留空捕获所有流量。%>
				</div>
			</div>
		</div>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:文件大小限制 (MB)%></label>
			<div class="cbi-value-field">
				<div class="file-size-row">
					<div class="file-size-container">
						<input type="number" id="filesize" class="cbi-input-text file-size-input" placeholder="10" min="1" max="100" />
						<span>MB</span>
						<span id="file-size-display" class="file-size-display" style="display: none;">
							<span>当前捕获文件大小: </span><span id="current-file-size">0 KB</span>
						</span>
					</div>
				</div>
				<div class="cbi-value-description">
					<%:最大文件大小 (1-100MB)，达到限制时自动停止抓包%>
				</div>
			</div>
		</div>

		<div class="cbi-value">
			<label class="cbi-value-title"><%:包数量限制%></label>
			<div class="cbi-value-field">
				<input type="number" id="count" class="cbi-input-text" placeholder="1000" min="1" max="100000" />
				<div class="cbi-value-description">
					<%:捕获指定数量的包后自动停止，留空表示无限制%>
				</div>
			</div>
		</div>
	</fieldset>

	<fieldset class="cbi-section">
		<legend><%:状态与控制%></legend>
		
		<div class="cbi-value">
			<label class="cbi-value-title"><%:状态%></label>
			<div class="cbi-value-field">
				<div id="status-container">
					<span id="status-text" class="status-indicator status-loading">
						<%:加载中...%>
					</span>
					<span id="interface-info" class="interface-info" style="display: none; margin-left: 10px;"></span>
				</div>
				<div id="size-progress" style="margin-top: 5px; display: none;">
					<div style="display: flex; justify-content: space-between; font-size: 0.8em; color: #666;">
						<span id="current-size-text">0 MB</span>
						<span id="limit-size-text">0 MB</span>
					</div>
					<div style="background: #f0f0f0; height: 6px; border-radius: 3px; margin-top: 2px;">
						<div id="size-progress-bar" style="background: #007bff; height: 100%; border-radius: 3px; width: 0%; transition: width 0.3s ease;"></div>
					</div>
				</div>
			</div>
		</div>

		<div class="cbi-value cbi-value-last">
			<label class="cbi-value-title"><%:操作%></label>
			<div class="cbi-value-field">
				<div class="tcpdump-btn-group">
					<button id="btn-start" class="tcpdump-btn tcpdump-btn-apply" onclick="startCapture()">
						<%:开始捕获%>
					</button>
					<button id="btn-stop" class="tcpdump-btn tcpdump-btn-reset" onclick="stopCapture()" disabled>
						<%:停止捕获%>
					</button>
					<button id="btn-download" class="tcpdump-btn tcpdump-btn-download" onclick="downloadCapture()" disabled>
						<%:下载文件%>
					</button>
					<button id="btn-delete" class="tcpdump-btn tcpdump-btn-remove" onclick="deleteCapture()" disabled>
						<%:删除文件%>
					</button>
				</div>
			</div>
		</div>
	</fieldset>

	<fieldset class="cbi-section">
		<legend><%:使用提示%></legend>
		<div class="cbi-section-descr">
			<ul class="tips-list">
				<li><%:快捷键: Ctrl+Enter 开始捕获, Ctrl+Esc 停止捕获%></li>
				<li><%:点击端口按钮快速添加过滤器%></li>
				<li><%:文件保存在 /tmp/tcpdump.pcap，重启后会丢失%></li>
				<li><%:设置文件大小限制后，达到限制时会自动停止抓包%></li>
				<li><%:使用 Wireshark 或 tcpdump 命令分析下载的 .pcap 文件%></li>
			</ul>
		</div>
	</fieldset>
</div>

<script type="text/javascript">
//<![CDATA[

// ------------------------------------------------
// 全局状态和配置
// ------------------------------------------------
var tcpdumpState = {
    isUpdating: false,
    lastUpdate: 0,
    updateInterval: 3000,
    sizeCheckInterval: 2000,
    sizeLimit: 0,
    lastFileSize: 0,
    isAutoStopped: false
};

// ------------------------------------------------
// 工具函数
// ------------------------------------------------
function formatFileSize(bytes) {
    if (bytes === 0 || !bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ------------------------------------------------
// 通知系统
// ------------------------------------------------
function showNotification(message, type) {
    var existingNotice = document.querySelector('.tcpdump-notice');
    if (existingNotice) {
        existingNotice.remove();
    }
    
    var notice = document.createElement('div');
    notice.className = 'tcpdump-notice alert-message ' + 
        (type === 'error' ? 'error' : type === 'success' ? 'success' : 'info');
    
    notice.innerHTML = '<p>' + message + '</p>';
    notice.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        min-width: 300px;
        max-width: 500px;
        padding: 15px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(notice);
    
    setTimeout(function() {
        if (notice.parentNode) {
            notice.style.animation = 'slideOut 0.3s ease';
            setTimeout(function() {
                if (notice.parentNode) {
                    notice.remove();
                }
            }, 300);
        }
    }, 5000);
}

// ------------------------------------------------
// 端口选择器逻辑
// ------------------------------------------------
function setupPortSelector() {
    var filterInput = document.getElementById('filter');
    var presetButtons = document.querySelectorAll('.tcpdump-btn-preset');
    var selectedPorts = new Set();
    
    presetButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            var port = this.dataset.port;
            
            if (selectedPorts.has(port)) {
                selectedPorts.delete(port);
                this.classList.remove('active');
            } else {
                selectedPorts.add(port);
                this.classList.add('active');
            }
            
            if (selectedPorts.size > 0) {
                var portsArray = Array.from(selectedPorts);
                if (portsArray.length === 1) {
                    filterInput.value = 'port ' + portsArray[0];
                } else {
                    filterInput.value = 'port ' + portsArray.join(' or port ');
                }
            } else {
                filterInput.value = '';
            }
        });
    });
    
    filterInput.addEventListener('input', function() {
        var newSelectedPorts = new Set();
        var matches = this.value.match(/port\s+(\d+)/g);
        
        if (matches) {
            matches.forEach(function(match) {
                var port = match.replace('port', '').trim();
                if (port && !isNaN(port)) {
                    newSelectedPorts.add(port);
                }
            });
        }
        
        selectedPorts = newSelectedPorts;
        
        presetButtons.forEach(function(button) {
            if (selectedPorts.has(button.dataset.port)) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    });
    
    filterInput.addEventListener('focus', function() {
        this.select();
    });
}

// ------------------------------------------------
// 高级过滤器构建器
// ------------------------------------------------
function showAdvancedFilterDialog() {
    var filterInput = document.getElementById('filter');
    var currentFilter = filterInput.value;
    
    var dialogHtml = `
        <div class="advanced-filter-dialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 20px; border-radius: 8px; width: 500px; max-width: 90%;">
                <h3><%:高级过滤器构建器%></h3>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;"><%:主机/IP地址:%></label>
                    <input type="text" id="adv-host" class="cbi-input-text" style="width: 100%;" placeholder="例如: 192.168.1.1 或 host example.com">
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;"><%:协议:%></label>
                    <select id="adv-protocol" class="cbi-input-select" style="width: 100%;">
                        <option value=""><%:所有协议%></option>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="icmp">ICMP</option>
                        <option value="arp">ARP</option>
                    </select>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;"><%:端口:%></label>
                    <input type="text" id="adv-port" class="cbi-input-text" style="width: 100%;" placeholder="例如: 80, 443, 或 1-1024">
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;"><%:网络段:%></label>
                    <input type="text" id="adv-network" class="cbi-input-text" style="width: 100%;" placeholder="例如: 192.168.1.0/24">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                    <button type="button" class="tcpdump-btn" onclick="closeAdvancedFilter()"><%:取消%></button>
                    <button type="button" class="tcpdump-btn tcpdump-btn-apply" onclick="applyAdvancedFilter()"><%:应用%></button>
                </div>
            </div>
        </div>
    `;
    
    var dialog = document.createElement('div');
    dialog.innerHTML = dialogHtml;
    document.body.appendChild(dialog);
    
    window.closeAdvancedFilter = function() {
        dialog.remove();
    };
    
    window.applyAdvancedFilter = function() {
        var host = document.getElementById('adv-host').value;
        var protocol = document.getElementById('adv-protocol').value;
        var port = document.getElementById('adv-port').value;
        var network = document.getElementById('adv-network').value;
        
        var filterParts = [];
        
        if (host) {
            if (host.match(/^\d/)) {
                filterParts.push('host ' + host);
            } else {
                filterParts.push('host ' + host);
            }
        }
        
        if (protocol) {
            filterParts.push(protocol);
        }
        
        if (port) {
            if (port.includes('-')) {
                filterParts.push('portrange ' + port);
            } else if (port.includes(',')) {
                var ports = port.split(',').map(p => 'port ' + p.trim()).join(' or ');
                filterParts.push('(' + ports + ')');
            } else {
                filterParts.push('port ' + port);
            }
        }
        
        if (network) {
            filterParts.push('net ' + network);
        }
        
        var finalFilter = filterParts.join(' and ');
        filterInput.value = finalFilter;
        dialog.remove();
    };
}

// ------------------------------------------------
// 接口管理
// ------------------------------------------------
function loadInterfaces() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/interfaces")%>', true);
    xhr.timeout = 10000;
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            var select = document.getElementById('interface');
            
            if (xhr.status === 200) {
                try {
                    var interfaces = JSON.parse(xhr.responseText);
                    
                    if (!interfaces || interfaces.length === 0) {
                        select.innerHTML = '<option value=""><%:未找到网络接口%></option>';
                        return;
                    }
                    
                    select.innerHTML = '';
                    var brLanExists = interfaces.includes('br-lan');
                    var defaultSelected = false;
                    
                    interfaces.forEach(function(iface) {
                        var option = document.createElement('option');
                        option.value = iface;
                        
                        if (iface === 'br-lan') {
                            option.textContent = 'br-lan (<%:默认%>)';
                            option.selected = true;
                            defaultSelected = true;
                        } else {
                            option.textContent = iface;
                        }
                        
                        select.appendChild(option);
                    });
                    
                    if (!brLanExists && interfaces.length > 0) {
                        select.firstChild.selected = true;
                    }
                    
                } catch(e) {
                    console.error('<%:加载接口时出错 (JSON解析失败)%>:', e);
                    select.innerHTML = '<option value=""><%:加载接口失败%></option>';
                }
            } else {
                console.error('<%:加载接口失败，状态码:%>', xhr.status);
                select.innerHTML = '<option value=""><%:加载接口失败 (HTTP %> ' + xhr.status + ')</option>';
            }
        }
    };
    
    xhr.ontimeout = function() {
        console.error('<%:加载接口请求超时%>');
    };
    
    xhr.send();
}

// ------------------------------------------------
// 输入验证
// ------------------------------------------------
function validateInputs() {
    var interface = document.getElementById('interface').value;
    var filter = document.getElementById('filter').value;
    var filesize = document.getElementById('filesize').value;
    var count = document.getElementById('count').value;
    
    var errors = [];
    
    if (!interface) {
        errors.push('请选择网络接口');
    }
    
    if (filter) {
        var dangerousChars = /[;&|`$]/;
        if (dangerousChars.test(filter)) {
            errors.push('过滤器中包含不安全的字符');
        }
    }
    
    if (filesize) {
        var size = parseInt(filesize);
        if (isNaN(size) || size < 1 || size > 100) {
            errors.push('文件大小必须在 1-100 MB 之间');
        }
    }
    
    if (count) {
        var packetCount = parseInt(count);
        if (isNaN(packetCount) || packetCount < 1 || packetCount > 100000) {
            errors.push('包数量必须在 1-100000 之间');
        }
    }
    
    return errors;
}

// ------------------------------------------------
// 文件大小检查
// ------------------------------------------------
function checkFileSize() {
    if (tcpdumpState.sizeLimit === 0) return;
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/check_size")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
            try {
                var data = JSON.parse(xhr.responseText);
                if (data.should_stop && data.stopped) {
                    tcpdumpState.isAutoStopped = true;
                    showNotification(data.message, 'success');
                    // 停止后恢复正常的检查间隔
                    tcpdumpState.sizeCheckInterval = 2000;
                    updateStatus();
                }
            } catch(e) {
                console.error('文件大小检查失败:', e);
            }
        }
    };
    
    xhr.send();
}

// ------------------------------------------------
// 状态管理
// ------------------------------------------------
function updateStatus() {
    if (tcpdumpState.isUpdating) return;
    
    var now = Date.now();
    if (now - tcpdumpState.lastUpdate < 1000) return;
    
    tcpdumpState.isUpdating = true;
    tcpdumpState.lastUpdate = now;
    
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '<%=url("admin/services/tcpdump/ajax_status")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            tcpdumpState.isUpdating = false;
            
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    updateUI(data);
                    
                    // 如果自动停止，显示通知
                    if (data.size_limit_reached && !tcpdumpState.isAutoStopped) {
                        tcpdumpState.isAutoStopped = true;
                        showNotification('已达到文件大小限制 (' + data.size_limit + 'MB)，抓包已自动停止', 'info');
                    }
                } catch(e) {
                    console.error('<%:更新状态时出错:%>', e);
                    showStatusError('<%:状态数据解析失败%>');
                }
            } else {
                console.error('<%:状态请求失败，状态码:%>', xhr.status);
                showStatusError('<%:状态请求失败 (HTTP %> ' + xhr.status + ')');
            }
        }
    };
    
    xhr.send();
}

function showStatusError(message) {
    var statusEl = document.getElementById('status-text');
    if (statusEl) {
        statusEl.className = 'status-indicator status-loading';
        statusEl.innerHTML = '<%:错误:%> ' + message;
    }
}

// ------------------------------------------------
// UI 更新函数
// ------------------------------------------------
function updateUI(data) {
    var statusEl = document.getElementById('status-text');
    var interfaceInfoEl = document.getElementById('interface-info');
    var currentFileSizeEl = document.getElementById('current-file-size');
    var fileSizeDisplayEl = document.getElementById('file-size-display');
    var sizeProgressEl = document.getElementById('size-progress');
    var currentSizeTextEl = document.getElementById('current-size-text');
    var limitSizeTextEl = document.getElementById('limit-size-text');
    var progressBarEl = document.getElementById('size-progress-bar');
    var startBtn = document.getElementById('btn-start');
    var stopBtn = document.getElementById('btn-stop');
    var downloadBtn = document.getElementById('btn-download');
    var deleteBtn = document.getElementById('btn-delete');
    
    if (!statusEl) return;
    
    var isRunning = data.running === true;
    var fileExists = data.file_exists === true;
    var fileSize = data.file_size || 0;
    var fileSizeHuman = data.file_size_human || formatFileSize(fileSize);
    var sizeLimit = data.size_limit || 0;
    
    // 更新状态显示
    if (isRunning) {
        statusEl.className = 'status-indicator status-running';
        var statusText = '<%:运行中%>';
        if (data.pid) statusText += ' (PID: ' + data.pid + ')';
        if (sizeLimit > 0) statusText += ' - 大小限制: ' + sizeLimit + 'MB';
        statusEl.textContent = statusText;
        
        if (data.interface) {
            interfaceInfoEl.style.display = 'inline';
            interfaceInfoEl.textContent = '接口: ' + data.interface;
        }
        
        // 显示进度条
        if (sizeLimit > 0) {
            sizeProgressEl.style.display = 'block';
            var currentMB = fileSize / (1024 * 1024);
            var progress = Math.min((currentMB / sizeLimit) * 100, 100);
            
            currentSizeTextEl.textContent = currentMB.toFixed(2) + ' MB';
            limitSizeTextEl.textContent = sizeLimit + ' MB';
            progressBarEl.style.width = progress + '%';
            
            // 根据进度改变颜色
            if (progress >= 90) {
                progressBarEl.style.background = '#dc3545';
            } else if (progress >= 70) {
                progressBarEl.style.background = '#ffc107';
            } else {
                progressBarEl.style.background = '#007bff';
            }
        } else {
            sizeProgressEl.style.display = 'none';
        }
    } else {
        statusEl.className = 'status-indicator status-stopped';
        statusEl.textContent = '<%:已停止%>';
        interfaceInfoEl.style.display = 'none';
        sizeProgressEl.style.display = 'none';
        
        // 重置自动停止标志
        tcpdumpState.isAutoStopped = false;
    }
    
    // 更新文件大小显示
    if (fileExists) {
        fileSizeDisplayEl.style.display = 'inline';
        currentFileSizeEl.textContent = fileSizeHuman;
    } else {
        fileSizeDisplayEl.style.display = 'none';
    }
    
    // 更新按钮状态
    if (startBtn) startBtn.disabled = isRunning;
    if (stopBtn) stopBtn.disabled = !isRunning;
    if (downloadBtn) downloadBtn.disabled = !fileExists || isRunning;
    if (deleteBtn) deleteBtn.disabled = !fileExists || isRunning;
}

// ------------------------------------------------
// 操作函数
// ------------------------------------------------
function startCapture() {
    var errors = validateInputs();
    if (errors.length > 0) {
        showNotification('错误: ' + errors.join(', '), 'error');
        return;
    }
    
    var interface = document.getElementById('interface').value;
    var filter = document.getElementById('filter').value;
    var filesize = document.getElementById('filesize').value;
    var count = document.getElementById('count').value;
    
    var startBtn = document.getElementById('btn-start');
    if (startBtn) {
        startBtn.disabled = true;
        startBtn.textContent = '启动中...';
    }
    
    // 设置大小限制
    if (filesize) {
        tcpdumpState.sizeLimit = parseInt(filesize);
    } else {
        tcpdumpState.sizeLimit = 0;
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/start")%>', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.timeout = 15000;
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.textContent = '开始捕获';
            }
            
            setTimeout(updateStatus, 1000);
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (result.success) {
                        showNotification(result.message, 'success');
                        // 如果设置了大小限制，启动更频繁的检查
                        if (filesize) {
                            tcpdumpState.sizeCheckInterval = 1000; // 1秒检查一次
                        }
                    } else {
                        showNotification('启动失败: ' + (result.message || '未知错误'), 'error');
                    }
                } catch(e) {
                    showNotification('响应解析失败', 'error');
                }
            } else {
                showNotification('请求失败: HTTP ' + xhr.status, 'error');
            }
        }
    };
    
    xhr.ontimeout = function() {
        showNotification('启动请求超时', 'error');
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.textContent = '开始捕获';
        }
    };
    
    var params = 'interface=' + encodeURIComponent(interface) + 
                 '&filter=' + encodeURIComponent(filter) + 
                 '&filesize=' + encodeURIComponent(filesize) +
                 '&count=' + encodeURIComponent(count);
    xhr.send(params);
}


function stopCapture() {
    var stopBtn = document.getElementById('btn-stop');
    var originalText = stopBtn ? stopBtn.textContent : '';
    
    if (stopBtn) {
        stopBtn.disabled = true;
        stopBtn.textContent = '停止中...';
    }
    
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/stop")%>', true);
    xhr.timeout = 15000;
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (stopBtn) {
                stopBtn.textContent = originalText;
            }
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (result.success) {
                        showNotification(result.message, 'success');
                        updateStatus();
                        setTimeout(updateStatus, 2000);
                    } else {
                        showNotification('停止失败: ' + (result.message || '未知错误'), 'error');
                        updateStatus();
                    }
                } catch(e) {
                    showNotification('响应解析失败', 'error');
                    updateStatus();
                }
            } else {
                showNotification('停止请求失败，状态码: ' + xhr.status, 'error');
                updateStatus();
            }
        }
    };
    
    xhr.ontimeout = function() {
        showNotification('停止请求超时，但进程可能仍在停止中', 'warning');
        if (stopBtn) {
            stopBtn.textContent = originalText;
        }
        updateStatus();
    };
    
    xhr.send();
}

function downloadCapture() {
    window.open('<%=url("admin/services/tcpdump/download")%>', '_blank');
}

function deleteCapture() {
    if (!confirm('<%:您确定要删除 /tmp/tcpdump.pcap 文件吗？此操作无法撤销。%>')) {
        return;
    }

    var deleteBtn = document.getElementById('btn-delete');
    if (deleteBtn) {
        deleteBtn.disabled = true;
    }

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '<%=url("admin/services/tcpdump/delete")%>', true);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            setTimeout(updateStatus, 500);
            
            if (xhr.status === 200) {
                try {
                    var result = JSON.parse(xhr.responseText);
                    if (result.success) {
                        showNotification(result.message, 'success');
                    } else {
                        showNotification(result.message || '删除失败', 'error');
                    }
                } catch(e) {
                    showNotification('删除响应解析失败', 'error');
                }
            } else {
                showNotification('删除请求失败: ' + xhr.status, 'error');
            }
        }
    };
    
    xhr.send();
}

function refreshInterfaces() {
    var refreshBtn = document.getElementById('btn-refresh');
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.textContent = '刷新中...';
    }
    
    loadInterfaces();
    
    setTimeout(function() {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.textContent = '刷新接口';
        }
    }, 1000);
}

// ------------------------------------------------
// 初始化
// ------------------------------------------------
document.addEventListener('DOMContentLoaded', function() {
    setupPortSelector();
    loadInterfaces();
    updateStatus();
    
    var filesizeInput = document.getElementById('filesize');
    if (filesizeInput) {
        filesizeInput.addEventListener('change', function() {
            var value = parseInt(this.value);
            if (value < 1) this.value = '';
            if (value > 100) this.value = 100;
        });
    }
    
    var countInput = document.getElementById('count');
    if (countInput) {
        countInput.addEventListener('change', function() {
            var value = parseInt(this.value);
            if (value < 1) this.value = '';
            if (value > 100000) this.value = 100000;
        });
    }
    
    setInterval(updateStatus, tcpdumpState.updateInterval);
    setInterval(checkFileSize, tcpdumpState.sizeCheckInterval);
    
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            updateStatus();
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'Enter':
                    e.preventDefault();
                    startCapture();
                    break;
                case 'Escape':
                    e.preventDefault();
                    stopCapture();
                    break;
            }
        }
    });
});

//]]>
</script>

<%+footer%>
