name: ğŸ› ï¸ ç¼–è¯‘ luci-app-tcpdump (è¾“å…¥ SDK é“¾æ¥)

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'SDK ä¸‹è½½é“¾æ¥ï¼ˆå¿…é¡»æ˜¯ .tar.xz æ ¼å¼ï¼‰'
        required: true
        default: 'https://downloads.immortalwrt.org/releases/23.05.7/targets/ramips/mt7620/immortalwrt-sdk-23.05.7-ramips-mt7620_gcc-12.3.0_musl.Linux-x86_64.tar.xz'

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      PACKAGE_NAME: luci-app-tcpdump

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: â¬ æ£€å‡ºæ’ä»¶ä»£ç 
        uses: actions/checkout@v4
        with:
          path: ${{ env.PACKAGE_NAME }}

      # æ­¥éª¤ 2ï¼šä¸‹è½½å¹¶è§£å‹ SDK
      - name: ğŸ“¥ ä¸‹è½½å¹¶è§£å‹ SDK
        env:
          SDK_URL: ${{ github.event.inputs.sdk_url }}
        run: |
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ SDKï¼š$SDK_URL"
          wget --progress=dot:giga "$SDK_URL" -O sdk.tar.xz || { 
            echo "âŒ SDK ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼" 
            exit 1 
          }

          echo "ğŸ“¦ æ­£åœ¨è§£å‹ SDK..."
          tar -xf sdk.tar.xz
          SDK_DIR=$(tar -tf sdk.tar.xz | head -1 | cut -f1 -d"/")
          mv "$SDK_DIR" sdk
          echo "âœ… SDK è§£å‹åˆ°ï¼šsdk/"

          # å¤åˆ¶æ’ä»¶åˆ° SDK - å…³é”®ï¼šä½¿ç”¨æ­£ç¡®çš„è·¯å¾„
          mkdir -p sdk/package/feeds/luci
          cp -r ${{ env.PACKAGE_NAME }} sdk/package/feeds/luci/
          echo "âœ… æ’ä»¶å·²å¤åˆ¶åˆ°ï¼šsdk/package/feeds/luci/${{ env.PACKAGE_NAME }}/"

      # æ­¥éª¤ 3ï¼šå®‰è£…ç¼–è¯‘ä¾èµ–
      - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -qq
          sudo apt install -y -qq build-essential ccache ecj fastjar file g++ gawk \
            gettext git java-propose-classpath libelf-dev libncurses5-dev libssl-dev \
            python3 python3-dev python3-pip python3-setuptools python3-wheel unzip \
            wget xz-utils zlib1g-dev rsync

      # æ­¥éª¤ 4ï¼šæ›´æ–° feeds - å…³é”®ï¼šå…ˆæ›´æ–° luci feed
      - name: ğŸ”„ æ›´æ–° feeds
        working-directory: ./sdk
        run: |
          echo "ğŸ”„ æ­£åœ¨æ›´æ–°è½¯ä»¶åŒ…æº..."
          ./scripts/feeds update luci
          ./scripts/feeds install -a

      # æ­¥éª¤ 5ï¼šé…ç½®ç¼–è¯‘é€‰é¡¹
      - name: âš™ï¸ é…ç½®ç¼–è¯‘é€‰é¡¹
        working-directory: ./sdk
        run: |
          # ç”Ÿæˆé»˜è®¤é…ç½®
          make defconfig
          
          # æ·»åŠ å¿…è¦çš„åŒ…é…ç½®
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-base=y" >> .config
          echo "CONFIG_PACKAGE_luci-lib-nixio=y" >> .config
          echo "CONFIG_PACKAGE_luci-mod-rpc=y" >> .config
          echo "CONFIG_PACKAGE_tcpdump=y" >> .config
          echo "CONFIG_PACKAGE_libpcap=y" >> .config
          echo "CONFIG_PACKAGE_${{ env.PACKAGE_NAME }}=m" >> .config
          
          # è®©ç³»ç»Ÿè‡ªåŠ¨è§£æä¾èµ–
          make defconfig
          echo "âœ… é…ç½®å®Œæˆ"

      # æ­¥éª¤ 6ï¼šè°ƒè¯•æ­¥éª¤ - æ£€æŸ¥åŒ…æ˜¯å¦å­˜åœ¨
      - name: ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥åŒ…ç»“æ„
        working-directory: ./sdk
        run: |
          echo "ğŸ” æ£€æŸ¥åŒ…ç›®å½•ç»“æ„..."
          find . -name "*tcpdump*" -type d | head -20
          echo "ğŸ” æ£€æŸ¥ feeds çŠ¶æ€..."
          ./scripts/feeds list | grep tcpdump || echo "æœªåœ¨ feeds ä¸­æ‰¾åˆ°"
          echo "ğŸ” æ£€æŸ¥åŒ…æ–‡ä»¶..."
          ls -la package/feeds/luci/${{ env.PACKAGE_NAME }}/ || echo "åŒ…ç›®å½•ä¸å­˜åœ¨"

      # æ­¥éª¤ 7ï¼šç¼–è¯‘æ’ä»¶ - ä½¿ç”¨æ­£ç¡®çš„ç›®æ ‡è·¯å¾„
      - name: ğŸ› ï¸ ç¼–è¯‘æ’ä»¶
        working-directory: ./sdk
        run: |
          echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘æ’ä»¶ï¼š${{ env.PACKAGE_NAME }}"
          # ä½¿ç”¨ feeds è·¯å¾„ç¼–è¯‘
          make package/feeds/luci/${{ env.PACKAGE_NAME }}/compile V=s

      # æ­¥éª¤ 8ï¼šæ”¶é›†å¹¶ä¸Šä¼  IPK æ–‡ä»¶
      - name: ğŸ“¤ ä¸Šä¼  IPK æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-ipk
          path: |
            sdk/bin/packages/**/**/luci-app-tcpdump*.ipk
            sdk/bin/packages/**/**/luci-app-tcpdump*.ipk.manifest
          if-no-files-found: error
          retention-days: 7

      # æ­¥éª¤ 9ï¼šæ˜¾ç¤ºç¼–è¯‘ç»“æœæ‘˜è¦
      - name: ğŸ“‹ ç¼–è¯‘ç»“æœæ‘˜è¦
        run: |
          echo "ğŸ‰ ç¼–è¯‘å®Œæˆï¼"
          echo "ğŸ“¦ ç”Ÿæˆçš„ IPK æ–‡ä»¶ï¼š"
          find sdk/bin/packages -name "luci-app-tcpdump*.ipk" -type f | while read file; do
            echo "   - $file ($(du -h "$file" | cut -f1))"
          done
