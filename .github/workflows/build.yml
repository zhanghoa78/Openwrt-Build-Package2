name: Build IPK with ImmortalWrt 23.05.7 SDK

on:
  push:
    branches:
      - main
  workflow_dispatch: # 允许手动点击 "Run workflow"

env:
  # 您提供的 SDK 链接
  SDK_URL: "https://downloads.immortalwrt.org/releases/23.05.7/targets/ramips/mt7620/immortalwrt-sdk-23.05.7-ramips-mt7620_gcc-12.3.0_musl.Linux-x86_64.tar.xz"
  SDK_FILE: "immortalwrt-sdk.tar.xz"
  
jobs:
  build-ipk:
    runs-on: ubuntu-latest

    steps:
      - name: Download and Extract SDK
        run: |
          wget -O $SDK_FILE "$SDK_URL"
          tar -xJvf $SDK_FILE
          # 找到解压后的 SDK 目录名
          SDK_DIR=$(ls -d */ | grep 'immortalwrt-sdk')
          echo "SDK_DIR=$SDK_DIR" >> $GITHUB_ENV

      - name: Checkout package source
        uses: actions/checkout@v4
        with:
          # 将您的 luci-app-tcpdump 仓库代码
          # 检出到 SDK 的 package/luci-app-tcpdump 目录中
          path: ${{ env.SDK_DIR }}/package/luci-app-tcpdump

      - name: Compile the package
        run: |
          cd ${{ env.SDK_DIR }}
          # 运行 SDK 的 make 命令来编译您的包
          make package/luci-app-tcpdump/compile V=s

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v3
        with:
          name: luci-app-tcpdump-ipk-ramips
          path: |
            ${{ env.SDK_DIR }}/bin/packages/mipsel_24kec_dsp/luci/luci-app-tcpdump_*.ipk
            ${{ env.SDK_DIR }}/bin/packages/mipsel_24kec_dsp/base/tcpdump_*.ipk
