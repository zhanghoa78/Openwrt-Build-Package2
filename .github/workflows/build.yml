name: ğŸ› ï¸ ç¼–è¯‘ luci-app-tcpdump

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: 'SDK ä¸‹è½½é“¾æ¥ï¼ˆå¿…é¡»æ˜¯ .tar.xz æ ¼å¼ï¼‰'
        required: true
        default: 'https://downloads.immortalwrt.org/releases/23.05.7/targets/ramips/mt7620/immortalwrt-sdk-23.05.7-ramips-mt7620_gcc-12.3.0_musl.Linux-x86_64.tar.xz'

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # å°†åŒ…åå®šä¹‰ä¸ºç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿å¼•ç”¨
      PACKAGE_NAME: luci-app-tcpdump
      # âœ… å·²ä¿®æ­£ï¼šç›´æ¥ä½¿ç”¨ URL å­—ç¬¦ä¸²ä½œä¸ºå”¯ä¸€æ ‡è¯†ç¬¦
      SDK_URL_STRING: ${{ github.event.inputs.sdk_url }}

    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: â¬ æ£€å‡ºæ’ä»¶ä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤ 2ï¼šä¸‹è½½å¹¶è§£å‹ SDK
      - name: ğŸ“¥ ä¸‹è½½å¹¶è§£å‹ SDK
        env:
          SDK_URL: ${{ github.event.inputs.sdk_url }}
        run: |
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ SDKï¼š$SDK_URL"
          wget --quiet "$SDK_URL" -O sdk.tar.xz || { echo "âŒ SDK ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼"; exit 1; }
          
          echo "ğŸ“¦ æ­£åœ¨è§£å‹ SDK..."
          # åˆ›å»ºç›®æ ‡ç›®å½•ï¼Œå¹¶ä½¿ç”¨ --strip-components=1 è§£å‹ï¼Œæ›´å¥å£®
          mkdir -p sdk
          tar -xf sdk.tar.xz --strip-components=1 -C sdk
          
          echo "âœ… SDK å·²å‡†å¤‡å°±ç»ª"

      # æ­¥éª¤ 3ï¼šå®‰è£…ç¼–è¯‘ä¾èµ–
      - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq build-essential ccache ecj fastjar file g++ gawk \
            gettext git libelf-dev libncurses5-dev libssl-dev python3 python3-dev \
            unzip wget xz-utils zlib1g-dev

      # æ­¥éª¤ 4ï¼šç¼“å­˜ OpenWrt ä¸‹è½½å’Œ feeds
      - name:  caching ç¼“å­˜ dl ç›®å½•å’Œ feeds
        uses: actions/cache@v4
        with:
          path: |
            sdk/dl
            sdk/feeds
          # âœ… å·²ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„ SDK_URL_STRING å˜é‡
          key: ${{ runner.os }}-openwrt-${{ env.SDK_URL_STRING }}-${{ hashFiles('sdk/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ env.SDK_URL_STRING }}-

      # æ­¥éª¤ 5ï¼šå¤åˆ¶æ’ä»¶å¹¶æ›´æ–° feeds
      - name: ğŸ”„ å¤åˆ¶æ’ä»¶å¹¶æ›´æ–° feeds
        working-directory: ./sdk
        run: |
          # å°†æ’ä»¶å¤åˆ¶åˆ° package/custom ç›®å½•
          mkdir -p package/custom
          cp -r $GITHUB_WORKSPACE package/custom/${{ env.PACKAGE_NAME }}
          
          echo "âœ… æ’ä»¶å·²å¤åˆ¶åˆ° package/custom/${{ env.PACKAGE_NAME }}/"
          
          echo "ğŸ”„ æ­£åœ¨æ›´æ–°è½¯ä»¶åŒ…æº..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # æ­¥éª¤ 6ï¼šç”Ÿæˆé…ç½®ï¼ˆæ›´å¯é çš„æ–¹å¼ï¼‰
      - name: âš™ï¸ ç”Ÿæˆé…ç½®
        working-directory: ./sdk
        run: |
          # æ‹·è´é»˜è®¤é…ç½®
          cp .config.old .config || make defconfig
          
          # ä½¿ç”¨ OpenWrt çš„è„šæœ¬æ¥å¯ç”¨åŒ…å’Œå®ƒçš„ä¾èµ–
          echo "CONFIG_PACKAGE_${{ env.PACKAGE_NAME }}=m" >> .config
          
          # è®©ç¼–è¯‘ç³»ç»Ÿè‡ªåŠ¨å¤„ç†ä¾èµ–
          make defconfig
          
          echo "âœ… é…ç½®å·²ç”Ÿæˆ"

      # æ­¥éª¤ 7ï¼šç¼–è¯‘æ’ä»¶
      - name: ğŸ› ï¸ ç¼–è¯‘æ’ä»¶
        working-directory: ./sdk
        run: |
          echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘æ’ä»¶ï¼š${{ env.PACKAGE_NAME }}"
          # æ£€æŸ¥åŒ…æ˜¯å¦è¢«è¯†åˆ«
          ./scripts/feeds list | grep ${{ env.PACKAGE_NAME }} || { echo "âŒ æ’ä»¶æœªè¢«ç¼–è¯‘ç³»ç»Ÿè¯†åˆ«ï¼"; exit 1; }
          
          # ç¼–è¯‘ç‰¹å®šåŒ…ï¼ŒV=s æä¾›è¯¦ç»†æ—¥å¿—
          make package/${{ env.PACKAGE_NAME }}/compile V=s -j$(nproc)

      # æ­¥éª¤ 8ï¼šæ•´ç†å¹¶ä¸Šä¼  IPK æ–‡ä»¶
      - name: ğŸ“¤ ä¸Šä¼  .ipk æ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-ipks
          # ä¼˜åŒ–è·¯å¾„ï¼Œåªä¸Šä¼ æˆ‘ä»¬è‡ªå·±ç¼–è¯‘çš„åŒ…å’Œå®ƒçš„ç›´æ¥ä¾èµ–
          path: sdk/bin/packages/**/custom/*.ipk
          if-no-files-found: error

